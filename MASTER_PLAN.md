# MASTER PLAN — Axentrait Mini App

> Полный список улучшений. Ничего не реализовано — только план.
> Оценка сложности: `простая` < 30 мин · `средняя` 30–90 мин · `сложная` > 90 мин

---

## Блок 1 — Критические баги

| # | Что исправить | Файл(ы) | Сложность |
|---|---------------|---------|-----------|
| 1.1 | **Нет маршрута к Account в BottomNav.** Навигация содержит 4 таба (Услуги, Кейсы, AI-демо, Заявка), но Account (`/account`) недоступен — пользователь не может попасть в профиль ни из одного экрана, кроме прямого URL | `components/layout/BottomNav.tsx` | простая |
| 1.2 | **Разнобой в аналитике: `track` vs `trackEvent`.** Часть экранов импортирует `track` из `shared/analytics/track`, другая часть — `trackEvent` из `shared/analytics/trackEvent`. Возможны пропущенные или дублированные события | `SplashPage`, `WelcomePage`, `SurveyPage`, `OnboardingResultPage`, `ServicesCatalogPage`, `ServiceDetailPage`, `CasesGalleryPage`, `CaseDetailPage`, `AiHubPage`, `AiChatPage`, `AiResultPage`, `LeadFormPage`, `AccountPage` | средняя |
| 1.3 | **MjImage — несовместимые пропы `id` vs `src`.** `SplashPage` и `AiHubPage` передают `id`, а `ServiceDetailPage` (строка 87) и `CaseDetailPage` (строка 54) передают `src` + `fallbackGradient`. Если компонент ожидает один интерфейс — второй молча сломается | `ServiceDetailPage.tsx:87`, `CaseDetailPage.tsx:54`, компонент `MjImage` | средняя |
| 1.4 | **SurveyPage — ошибка `submitOnboardingAnswers` проглатывается.** `catch {}` пустой (строка 86-88). Пользователь не видит, что данные не ушли на бэкенд, и идёт на result-страницу с пустым ответом | `SurveyPage.tsx:84-88` | простая |
| 1.5 | **LeadFormPage — `zodResolver as any`.** Каст `as any` (строка 71) обходит типизацию. При несовпадении схемы и формы ошибка не будет поймана на этапе компиляции | `LeadFormPage.tsx:71` | простая |
| 1.6 | **Нет ErrorBoundary вокруг роутера.** Любая необработанная ошибка в lazy-чанке или рендере даёт белый экран без возможности восстановления | `App.tsx`, `router.tsx` | средняя |
| 1.7 | **OnboardingResultPage — нестабильные зависимости useEffect.** `[recommendedCase, recommendedServices]` — мемоизированные объекты, пересоздаваемые при каждом ответе сервера. `track()` может вызываться многократно | `OnboardingResultPage.tsx:78-85` | простая |
| 1.8 | **AiChatPage — `send()` молча глотает ошибки.** `catch {}` (строка 126-128) пустой; пользователь не видит, что сообщение не отправлено, а UI остаётся в состоянии "ждём ответ" | `AiChatPage.tsx:126-128` | простая |

---

## Блок 2 — Функциональность

| # | Что добавить / исправить | Файл(ы) | Сложность |
|---|--------------------------|---------|-----------|
| 2.1 | **Добавить таб «Профиль» в BottomNav** (5-й таб или заменить один из существующих). Иконка `User` из lucide | `BottomNav.tsx` | простая |
| 2.2 | **ErrorBoundary-компонент + fallback UI.** Обёртка для роутера с кнопкой «Перезагрузить» | Новый `components/ui/ErrorBoundary.tsx`, `App.tsx` | средняя |
| 2.3 | **Кастомная 404-страница вместо `<Navigate to="/" replace />`.** Сейчас любой несуществующий маршрут молча кидает на splash — пользователь не понимает, что пошло не так | `router.tsx`, новый `NotFoundPage.tsx` | простая |
| 2.4 | **Persist onboarding-ответов.** Если пользователь закроет приложение на шаге 3/5 и вернётся — состояние потеряно. Нужен `sessionStorage` или `zustand/persist` | `useOnboardingState.ts` | средняя |
| 2.5 | **Pull-to-refresh на списковых страницах** (Каталог услуг, Галерея кейсов). В Telegram Mini App это ожидаемый паттерн | `ServicesCatalogPage.tsx`, `CasesGalleryPage.tsx` | средняя |
| 2.6 | **Haptic-фидбэк на кнопки и навигацию.** Сейчас `tgHapticLight` вызывается только в Survey при выборе опции. Все основные CTA и табы — без отдачи | `BottomNav.tsx`, `Button.tsx`, все CTA-кнопки | средняя |
| 2.7 | **Telegram MainButton для ключевых CTA.** `WelcomePage` скрывает его (`visible: false`), нигде больше не используется. MainButton — самый заметный элемент TMA, нужно использовать для «Оставить заявку» на ServiceDetail, CaseDetail, OnboardingResult | `WelcomePage.tsx`, `ServiceDetailPage.tsx`, `CaseDetailPage.tsx`, `OnboardingResultPage.tsx` | средняя |
| 2.8 | **Deeplink-обработка** (`tg://resolve?startapp=...`). Сейчас `startapp` параметр не парсится — пользователь, пришедший по реферальной ссылке или из share, всегда попадает на splash | `App.tsx`, `router.tsx` | сложная |
| 2.9 | **Skeleton для BottomNav / TopBar при загрузке.** При первом lazy-load экрана TopBar и BottomNav отсутствуют → layout jump | `AppShell.tsx` | простая |
| 2.10 | **Ограничить отправку LeadForm офлайн.** Кнопка визуально disabled, но `doSubmit` может быть вызван через Enter. Нужен guard на уровне формы | `LeadFormPage.tsx` | простая |
| 2.11 | **ServiceDetailPage — fallback при пустом `longDescription`.** Если бэкенд вернёт пустую строку, блок рендерится как пустой Card | `ServiceDetailPage.tsx:104-120` | простая |
| 2.12 | **AiChatPage — замена URL при навигации `new` → sessionId.** `navigate(..., { replace: true })` сейчас есть, но при быстром двойном отправлении возможна гонка, т.к. `sessionId` обновляется асинхронно | `AiChatPage.tsx:37-40` | средняя |

---

## Блок 3 — Визуал (экран за экраном)

### 3.1 SplashPage (`features/onboarding/SplashPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.1.1 | Все стили инлайн — вынести в CSS-классы (`ax-splash-bg`, `ax-splash-content`) | простая |
| 3.1.2 | Текст «Загрузка Mini App shell...» не стилизован и выглядит как дебаг-сообщение. Заменить на минимальную индикацию или убрать | простая |
| 3.1.3 | Кнопка «Пропустить» в правом верхнем углу — без отступа от safe-area, может перекрываться системным UI на iPhone | простая |

### 3.2 WelcomePage (`features/onboarding/WelcomePage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.2.1 | 40+ строк inline-стилей. Вынести в CSS-классы | средняя |
| 3.2.2 | Overlay-градиент (`rgba(5,10,15,...)`) хардкожен — не адаптируется к Telegram-теме | простая |
| 3.2.3 | `maxWidth: 340` на заголовке жёстко задан — на узких экранах < 340px будет переполнение | простая |
| 3.2.4 | `paddingBottom: 48` для кнопок — не учитывает safe-area-inset-bottom | простая |

### 3.3 SurveyPage (`features/onboarding/SurveyPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.3.1 | `optionStyle()` возвращает CSSProperties объект на каждый рендер — вынести в CSS-класс `.ax-survey-option` + `.ax-survey-option--selected` | простая |
| 3.3.2 | Прогресс-бар (`ax-dots`) мелкий и неинтуитивный. Заменить на линейный прогресс-бар с анимацией | средняя |
| 3.3.3 | Нет анимации перехода между шагами (только `ax-step-slide-left` при первом рендере) | средняя |

### 3.4 OnboardingResultPage (`features/onboarding/OnboardingResultPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.4.1 | Повторяющийся паттерн `resultConfig.sections?.find(...)` (строки 59-76) — 8 одинаковых конструкций. Вынести в хелпер `getSectionConfig(type)` | простая |
| 3.4.2 | Секция «Подходящие услуги» визуально не отличается от «Похожий кейс» — нужна визуальная иерархия (разные card-variants, размеры) | средняя |
| 3.4.3 | Кнопка «Задайте вопрос искусственному интеллекту» (строка 156) — слишком длинный текст для кнопки, обрезается на узких экранах | простая |

### 3.5 ServicesCatalogPage (`features/services/ServicesCatalogPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.5.1 | Строка поиска: inline-стили для `label` и `input` (строки 70-88). Вынести в CSS-класс `.ax-search-bar` | простая |
| 3.5.2 | Чипы категорий не имеют горизонтального скролла с fade-out — обрезаются на краях | простая |
| 3.5.3 | Нет состояния «нет результатов по поиску» отдельного от «нет результатов по категории» — пользователь не понимает, что именно пусто | простая |

### 3.6 ServiceDetailPage (`features/services/ServiceDetailPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.6.1 | 50+ строк inline-стилей с хардкод-цветами (`rgba(240,246,252,0.6)` и т.п.). Вынести в CSS-переменные и классы | средняя |
| 3.6.2 | Hero-секция (строки 77-101) — нет max-height, на длинных заголовках может растянуться | простая |
| 3.6.3 | Кнопки «Сравнить пакеты» / «Рассчитать ROI» одного размера и приоритета — нужна визуальная иерархия | простая |
| 3.6.4 | Блок «Предпосылки к старту» визуально сливается с «Что вы получите» — нужен разделитель или другой стиль | простая |
| 3.6.5 | Двойные кнопки внизу («Оставить заявку» + «Все услуги») — слишком много CTA, конкурируют за внимание | простая |

### 3.7 CasesGalleryPage (`features/cases/CasesGalleryPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.7.1 | Чипы индустрий — те же проблемы, что в 3.5.2 (нет fade-out, обрезка) | простая |
| 3.7.2 | Нет поиска по кейсам (в отличие от каталога услуг) | средняя |

### 3.8 CaseDetailPage (`features/cases/CaseDetailPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.8.1 | Hero-секция (строки 52-78) — inline-стили, хардкод-цвета | простая |
| 3.8.2 | Три секции «Что было / Что сделали / Что получили» — одинаковые Card без визуального различия. Нужны иконки или accent-цвета | средняя |
| 3.8.3 | Badge-компоненты для стека и тегов (строки 116-127) — одинаковый стиль, не видна разница между тегами и технологиями | простая |
| 3.8.4 | Три кнопки внизу (Запросить решение / Before-After / Видео и отзывы) — нет визуальной иерархии, одинаковый вес | простая |

### 3.9 AiHubPage (`features/ai/AiHubPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.9.1 | `scenarioCardStyle()` создаёт объект стилей при каждом вызове — вынести в CSS | простая |
| 3.9.2 | `iconCircleStyle` — хардкод rgba-цвета, не связан с дизайн-системой | простая |
| 3.9.3 | Карточки сценариев — клик по `div` с `role="button"` вместо `<button>`. Accessibility-проблема | простая |
| 3.9.4 | Hero-секция идентична CaseDetailPage, но с другим фоном — нет единого hero-компонента | средняя |

### 3.10 AiChatPage (`features/ai/AiChatPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.10.1 | Warning-бар (строки 140-159) — 20 строк inline-стилей. Вынести в CSS-класс `.ax-chat-warning` | простая |
| 3.10.2 | Chat-список фиксирован `max-height: min(55dvh, 520px)` — на маленьких экранах остаётся мало места, на больших — неиспользуемое пространство | средняя |
| 3.10.3 | Typing-индикатор (строки 205-213) — `bubble-bot` класс не совпадает с системой `ax-message.assistant` | простая |
| 3.10.4 | QuickPromptChips не скрываются после первого сообщения — занимают место | простая |

### 3.11 AiResultPage (`features/ai/AiResultPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.11.1 | Заголовок «Структурированный JSON пока не получен» (строка 111) — техническая терминология, пользователь не поймёт. Заменить на «Подробный отчёт формируется» | простая |
| 3.11.2 | Markdown рендерится через `ReactMarkdown` без кастомизации — стили по умолчанию могут не совпадать с дизайн-системой | средняя |

### 3.12 LeadFormPage (`features/leads/LeadFormPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.12.1 | Нет визуального индикатора обязательных полей (звёздочка или пометка) | простая |
| 3.12.2 | Чипы услуг (строки 244-257) не имеют ограничения по количеству видимых — при 10+ услугах займут весь экран | простая |
| 3.12.3 | Отступ `marginTop: 24, marginBottom: 32` на кнопке submit — хардкод, не из дизайн-системы | простая |
| 3.12.4 | Нет промежуточного success-состояния перед навигацией на LeadSuccessPage | простая |

### 3.13 AccountPage (`features/account/AccountPage.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.13.1 | Карточки заявок (строки 83-96) используют `.ax-card` класс напрямую вместо `<Card>` компонента | простая |
| 3.13.2 | Отображение `lead.status` «as is» — бэкенд может вернуть `pending`, `in_progress` и т.п. на английском | простая |
| 3.13.3 | Лимит 5 заявок (`.slice(0, 5)`) без кнопки «Показать ещё» | простая |

### 3.14 TopBar (`components/layout/TopBar.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.14.1 | Нет разделителя / тени снизу — TopBar визуально сливается с контентом при скролле | простая |
| 3.14.2 | Заголовок не truncate-ится — длинные title (`Задайте вопрос искусственному интеллекту`) выходят за экран | простая |

### 3.15 BottomNav (`components/layout/BottomNav.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.15.1 | Иконки нерепрезентативны: `Diamond` для услуг, `Grid3X3` для кейсов, `Play` для заявки — не интуитивно | простая |
| 3.15.2 | Нет анимации при переключении табов | простая |
| 3.15.3 | `DiamondFilled` — кастомный SVG для AI-демо, но визуально почти одинаков с `Diamond` для услуг | простая |

### 3.16 AppShell (`components/layout/AppShell.tsx`)

| # | Что исправить | Сложность |
|---|---------------|-----------|
| 3.16.1 | `paddingBottom: 'calc(64px + env(...))'` хардкодит высоту BottomNav (64px). Если BottomNav изменится — layout сломается | простая |
| 3.16.2 | Нет scroll-to-top при навигации между страницами | простая |

---

## Блок 4 — Полировка

| # | Что исправить | Файл(ы) | Сложность |
|---|---------------|---------|-----------|
| 4.1 | **Вынести все inline-стили в CSS-классы.** Практически каждый экран содержит 20-50+ строк inline-стилей с хардкод-цветами. Перевести на CSS-переменные из дизайн-системы (`tokens.css`, `global.css`) | Все page-компоненты | сложная |
| 4.2 | **Унифицировать цвета.** `rgba(240,246,252,0.6)`, `rgba(255,255,255,0.06)`, `#22D3EE` встречаются повсюду — должны быть CSS-переменными `--ax-text-secondary`, `--ax-border`, `--ax-accent` | Все файлы | сложная |
| 4.3 | **Единый Hero-компонент.** `CaseDetailPage`, `AiHubPage` и `ServiceDetailPage` рендерят hero-секцию почти идентичным кодом — нужен `<HeroSection>` | Новый `components/ui/HeroSection.tsx` | средняя |
| 4.4 | **Типографика: CSS-классы вместо inline font-size/weight.** `fontSize: 24, fontWeight: 700` повторяются в десятке мест — должны быть `.ax-h1`, `.ax-h2`, `.ax-body` | `typography.css`, все page-компоненты | средняя |
| 4.5 | **Accessibility-аудит.** Интерактивные `div` с `onClick` без `role="button"` / `tabIndex` (кроме AiHubPage, где это частично сделано). Отсутствуют `aria-label` на иконках | Все page-компоненты | средняя |
| 4.6 | **Transition-анимации между маршрутами.** Сейчас есть только `page-enter` (fadeIn) на `ax-content`. Нет exit-анимации, нет direction-aware transitions | `AppShell.tsx`, `global.css` | сложная |
| 4.7 | **Оптимизация ре-рендеров.** `useMemo` / `useCallback` отсутствуют на callback-функциях, передаваемых в children (напр. `onClick={() => navigate(...)}`). React 18+ бэтчинг смягчает проблему, но при длинных списках (кейсы, услуги) может быть заметно | Все list-страницы | средняя |
| 4.8 | **i18n-готовность.** Все строки на русском хардкожены. Даже если i18n не нужен сейчас — строки стоит вынести в константы для единообразия и удобства правок | Все файлы | сложная |
| 4.9 | **Консистентный spacing.** Inline-стили используют `gap: 8`, `gap: 10`, `gap: 12`, `marginTop: 20`, `marginBottom: 32` — вместо `--ax-space-*` переменных | Все page-компоненты | средняя |
| 4.10 | **Preload критических чанков.** Lazy routes без prefetch — при первом переходе есть задержка. Добавить `<link rel="prefetch">` для ServicesCatalog и CasesGallery | `index.html` или webpack/vite config | средняя |
| 4.11 | **Темизация Telegram.** `initTelegramThemeBridge()` вызывается, но inline-стили с хардкод rgba-цветами не реагируют на тему. Нужно проверить что `--app-*` переменные подхватываются везде | `telegramTheme.ts`, все компоненты с inline-цветами | средняя |
| 4.12 | **Дублирование кода онлайн/офлайн.** `App.tsx`, `AiChatPage.tsx`, `LeadFormPage.tsx` — три независимых `useEffect` для `online/offline`. Вынести в хук `useOnlineStatus()` | Новый `shared/hooks/useOnlineStatus.ts` | простая |

---

## Итого

| Блок | Пунктов | Простых | Средних | Сложных |
|------|---------|---------|---------|---------|
| 1. Баги | 8 | 4 | 4 | 0 |
| 2. Функциональность | 12 | 5 | 6 | 1 |
| 3. Визуал | 40 | 30 | 10 | 0 |
| 4. Полировка | 12 | 1 | 7 | 4 |
| **Всего** | **72** | **40** | **27** | **5** |

---

## Рекомендуемый порядок выполнения

1. Блок 1 целиком (критические баги)
2. Блок 2: пункты 2.1–2.3, 2.6 (быстрые wins)
3. Блок 3: по одному экрану за итерацию, начиная с самых посещаемых (Welcome → ServicesCatalog → AiChat)
4. Блок 4: после стабилизации — рефакторинг стилей и полировка
